/** Here is yet another implementation of XPath 1.0 in Javascript.
 *
 * My goal was to make it relatively compact, but as I fixed all the axis bugs
 * the axes became more and more complicated. :-(.
 *
 * I have not implemented namespaces or case-sensitive axes for XML yet.
 *
 * How to test it in Chrome: You can make a Chrome extension that replaces
 * the WebKit XPath parser with this one. But it takes a bit of effort to
 * get around isolated world and same-origin restrictions:
 * manifest.json:
    {
      "name": "XPathTest",
      "version": "0.1",
      "content_scripts": [{
        "matches": ["http://localhost/*"],  // or wildcard host
        "js": ["xpath.js", "injection.js"],
        "all_frames": true, "run_at": "document_start"
      }]
    }
 * injection.js:
    // goal: give my xpath object to the website's JS context.
    var script = document.createElement('script');
    script.textContent =
        "document.addEventListener('xpathextend', function(e) {\n" +
        "  console.log('extending document with xpath...');\n" +
        "  e.detail(window);" +
        "});";
    document.documentElement.appendChild(script);
    document.documentElement.removeChild(script);
    var evt = document.createEvent('CustomEvent');
    evt.initCustomEvent('xpathextend', true, true, this.xpath.extend);
    document.dispatchEvent(evt);
 */
!function(){function t(t,e,n,r){var o=t(e,n);if(null==o)return null;for(var i;i=e.trypop(r);){var a=t(e,n);if(null==a)throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Expected something after "+i);o=n.node(i,o,a)}return o}function e(t,e){return n(t,e)||r(null,t,e)}function n(t,e){var n=t.peek();if("/"===n||"//"===n){var o=e.node("Root");return r(o,t,e,!0)}return null}function r(t,e,n,r){if(null==t&&(t=o(e,n),null==t))return t;for(var i;i=e.trypop(["/","//"]);){"//"===i&&(t=n.node("/",t,n.node("Axis","descendant-or-self","node",void 0)));var a=o(e,n);if(null==a&&"/"===i&&r)return t;if(r=!1,null==a)throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Expected step after "+i);t=n.node("/",t,a)}return t}function o(t,e){var n=t.trypop([".",".."]);if("."===n)return e.node("Axis","self","node");if(".."===n)return e.node("Axis","parent","node");var r,o=i(t,e),c=a(t,e);if(null==c&&(r=u(t,e)),null==o&&null==c&&null==r)return null;if(null==c&&null==r)throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected nodeTest after axisSpecifier "+o);null==o&&(o="child"),null==c&&(c="attribute"===o?"attribute":"namespace"===o?"namespace":"element");for(var l,h=e.node("Axis",o,c,r);null!=(l=s(h,t,e));)h=l;return h}function i(t){var e=t.trypop("@");if(null!=e)return"attribute";var n=t.trypopaxisname();if(null!=n){var r=t.trypop("::");if(null==r)throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Should not happen. Should be ::.");return n}}function a(t){if("("!==t.peek2())return null;var e=t.trypop(["comment","text","processing-instruction","node"]);if(null!=e){if(null==t.trypop("("))throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Should not happen.");var n=void 0;if("processing-instruction"==e&&(n=t.trypopliteral()),null==t.trypop(")"))throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected close parens.");return e}}function u(t){var e=t.trypopnametest();return null!=e?e:null}function s(t,e,n){if(null==e.trypop("["))return null;var r=d(e,n);if(null==r)throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Expected expression after [");if(null==e.trypop("]"))throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+e.position()+": Expected ] after expression.");return n.node("Predicate",t,r)}function c(t,e){var n=t.trypopliteral();if(null==n&&(n=t.trypopnumber()),null!=n)return n;var r=t.trypopvarref();if(null!=r)return e.node("VariableReference",r);var o=l(t,e);if(null!=o)return o;if(t.trypop("(")){var i=d(t,e);if(null==i)throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected expression after (.");if(null==t.trypop(")"))throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected ) after expression.");return i}return null}function l(t,e){var n=t.trypopfuncname(t,e);if(null==n)return null;if(null==t.trypop("("))throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected ( ) after function name.");for(var r=[],o=!0;null==t.trypop(")");){if(!o&&null==t.trypop(","))throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected , between arguments of the function.");o=!1;var i=d(t,e);if(null==i)throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected expression as argument of function.");r.push(i)}return e.node("FunctionCall",n,r)}function h(e,n){return t(f,e,n,"|")}function f(t,n){var o=p(t,n);if(null==o){var i=e(t,n);if(null==i)throw new Error;return n.node("PathExpr",i)}var a=r(o,t,n,!1);return o===a?a:n.node("PathExpr",a)}function p(t,e){var n=c(t,e);if(null==n)return null;for(var r,o=n;null!=(r=s(o,t,e));)o=r;return o}function d(e,n){{var r=((e.peeked||"")+e.str,t(g,e,n,"or"));(e.peeked||"")+e.str}return r}function g(e,n){return t(m,e,n,"and")}function m(e,n){return t(_,e,n,["=","!="])}function _(e,n){return t(v,e,n,["<",">","<=",">="])}function v(e,n){return t(E,e,n,["+","-"])}function E(e,n){return t(y,e,n,["*","div","mod"])}function y(t,e){if(t.trypop("-")){var n=y(t,e);if(null==n)throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Expected unary expression after -");return e.node("UnaryMinus",n)}return h(t,e)}function N(t){this.nodes=[],this.pos=[],this.lasts=[],this.nextPos=[],this.seriesIndexes=[],this.isReverseAxis=t,this._pushToNodes=t?Array.prototype.unshift:Array.prototype.push}function b(t){for(var e=[],n=0;n<t.nodes.length;n++){var r=t.nodes[n];if(t.pos)for(var o=0;o<t.pos[n].length;++o)e.push({nodes:[r],pos:[[t.pos[n][o]]],lasts:[[t.lasts[n][o]]]});else e.push({nodes:[r],pos:[[n+1]],lasts:[[t.nodes.length]]})}return e}function O(t,e,n){this.nodeTypeNum=t,this.nodeName=e,this.shouldLowerCase=n,this.nodeNameTest=null==e?this._alwaysTrue:n?this._nodeNameLowerCaseEquals:this._nodeNameEquals}function T(t,e,n,r,o,i,a,u,s){for(var c=new O(e,n,r),l=new N(s);0<t.length;){var h=o.call(t);console.assert(null!=h),h=a(h),l.pushSeries();for(var f=1;null!=h;)!u&&c.matches(h)&&l.addNode(h),h===i.call(t)&&(o.call(t),l.pushSeries(),f++),u&&c.matches(h)&&l.addNode(h),h=a(h);for(;0<f--;)l.popSeries()}return l}function D(t){if(t.ownerElement){if(t.ownerElement.firstChild)return t.ownerElement.firstChild;t=t.ownerElement}do if(t.nextSibling)return t.nextSibling;while(t=t.parentNode);return null}function M(t){if(t.ownerElement&&(t=t.ownerElement),null!=t.firstChild)return t.firstChild;do{if(null!=t.nextSibling)return t.nextSibling;t=t.parentNode}while(t);return null}function w(t){if(t.ownerElement)return t.ownerElement;if(null!=t.previousSibling){for(t=t.previousSibling;null!=t.lastChild;)t=t.lastChild;return t}return null!=t.parentNode?t.parentNode:null}function R(t,e,n,r){for(var o=new O(e,n,r),i=new N(!1),a=t[0],u=[],s=0;s<t.length;s++){var c=t[s],l=D(c);l&&u.push(l)}if(0===u.length)return{nodes:[]};for(var h=0;a=M(a);){for(var s=u.length-1;s>=0;s--)a===u[s]&&(i.pushSeries(),u.splice(s,s+1),h++);h&&o.matches(a)&&i.addNode(a)}console.assert(0===u.length);for(var s=0;h>s;s++)i.popSeries();return i.finalize()}function x(t,e,n,r){var o=new O(e,n,r),i=t.pop();if(null==i)return{nodes:{}};for(var a={nodes:[],pos:[],lasts:[]},u=[i.parentNode||i.ownerElement],s=[1];i=w(i);){i===t[t.length-1]&&(u.push(t.pop()),s.push(1));var c,l=o.matches(i),h=!1;l&&(c=s.slice());for(var f=0;f<u.length;++f)i===u[f]?(u[f]=i.parentNode||i.ownerElement,l&&(c[f]=null)):l&&(c[f]=s[f]++,h=!0);h&&(a.nodes.unshift(i),a.pos.unshift(c))}for(var f=0;f<a.pos.length;++f){var p=[];a.lasts.push(p);for(var d=a.pos[f].length-1;d>=0;d--)null==a.pos[f][d]?a.pos[f].splice(d,d+1):p.unshift(s[d]-1)}return a}function I(t,e,n,r,o,i,a){for(;0<n.length&&null!=n[0].ownerElement;){var u=n.shift();o&&r.matches(u)&&(a.push(u),i.push(t.nodes.length))}null==e||o||r.matches(e)&&t.addNode(e);var s=!1;if(null==e){if(0===n.length)return;e=n.shift(),t.pushSeries(),s=!0}else 0<n.length&&e===n[0]&&(t.pushSeries(),s=!0,n.shift());o&&r.matches(e)&&t.addNode(e);for(var c=e.childNodes,l=0;l<c.length;++l){var h=c[l];I(t,h,n,r,o,i,a)}s&&t.popSeries()}function A(t,e,n,r,o){for(var i=new O(e,n,r),a=new N(!1),u=[],s=[];0<t.length;)I(a,null,t,i,o,u,s);a.finalize();for(var c=s.length-1;c>=0;--c)a.nodes.splice(u[c],u[c],s[c]),a.pos.splice(u[c],u[c],[1]),a.lasts.splice(u[c],u[c],[1]);return a}function S(t,e,n,r,o){for(var i=new O(e,n,r),a=[],u=0;u<t.length;++u){for(var s=t[u],c=!0,l=[];null!=s;)(!c||o)&&i.matches(s)&&l.push(s),c=!1,s=s.parentNode||s.ownerElement;0<l.length&&a.push(l)}for(var h=[],u=0;u<a.length;++u)h.push(a[u].length);for(var f=(new N(!0),{nodes:[],pos:[],lasts:[]});0<a.length;){for(var p=[a[0].length],d=[h[0]],s=a[0].pop(),u=a.length-1;u>0;--u)s===a[u][a[u].length-1]&&(p.push(a[u].length),d.push(h[u]),a[u].pop(),0===a[u].length&&(a.splice(u,u+1),h.splice(u,u+1)));0===a[0].length&&(a.shift(),h.shift()),f.nodes.push(s),f.pos.push(p),f.lasts.push(d)}return f}function C(t){var e=[t];for(null!=t.ownerElement&&(t=t.ownerElement,e.push(-1));null!=t;){for(var n=0;null!=t.previousSibling;)t=t.previousSibling,n++;e.push(n),t=t.parentNode}return e}function L(t,e){var n=Math.min(t.length-1,e.length-1),r=t.length,o=e.length;if(t[0]===e[0])return 0;for(var i,a=0;n>a&&(i=t[r-a-1]-e[o-a-1],0===i);++a);return(null==i||0===i)&&(i=r-o),0===i&&(i=t.nodeName-e.nodeName),0===i&&(i=1),i}function j(t){function e(t,e){return L(t.v,e.v)}for(var n=[],r=0;r<t.nodes.length;r++){var o=C(t.nodes[r]);n.push({v:o,n:t.nodes[r],p:t.pos[r],l:t.lasts[r]})}n.sort(e);for(var i={nodes:[],pos:[],lasts:[]},r=0;r<n.length;++r)i.nodes.push(n[r].n),i.pos.push(n[r].p),i.lasts.push(n[r].l);return i}function P(t,e){var n,r,o,i,a=[];if("object"!=typeof t)throw new Z(Z.INVALID_EXPRESSION_ERR,"Invalid LHS for | operator (expected node-set): "+t);if("object"!=typeof e)throw new Z(Z.INVALID_EXPRESSION_ERR,"Invalid LHS for | operator (expected node-set): "+e);for(;;){if(null==n&&(n=t.shift(),null!=n&&(o=C(n))),null==r&&(r=e.shift(),null!=r&&(i=C(r))),null==n||null==r)break;var u=L(o,i);0>u?(a.push(n),n=null,o=null):u>0?(a.push(r),r=null,i=null):n.nodeName<r.nodeName?(a.push(n),n=null,o=null):n.nodeName>r.nodeName?(a.push(r),r=null,i=null):n!==r?(a.push(r),r=null,i=null):(console.assert(n===r,u),r=null,i=null)}for(;n;)a.push(n),n=t.shift();for(;r;)a.push(r),r=e.shift();return a}function U(t,e,n,r){var o;if(o=r?z.number:"boolean"==typeof e||"boolean"==typeof n?z["boolean"]:"number"==typeof e||"number"==typeof n?z.number:z.string,"object"==typeof e&&"object"==typeof n){for(var i=0;i<e.nodes.length;++i)for(var a=o({nodes:[e.nodes[i]]}),u=0;u<n.nodes.length;++u){var s=o({nodes:[n.nodes[u]]});if(t(a,s))return!0}return!1}if("object"==typeof e&&e.nodes&&e.nodes.length){for(var i=0;i<e.nodes.length;++i){var a=o({nodes:[e.nodes[i]]}),c=o(n);if(t(a,c))return!0}return!1}if("object"==typeof n&&e.nodes&&e.nodes.length){for(var i=0;i<e.nodes.length;++i){var l=o({nodes:[n.nodes[i]]}),h=o(e);if(t(h,l))return!0}return!1}var h=o(e),c=o(n);return t(h,c)}var k,H;"function"==typeof require?(k=require("../level3/core").dom.level3.core,H=exports):(k=this,H={});var q=H.Stream=function(t){this.original=this.str=t,this.peeked=null,this.prev=null,this.prevprev=null};q.prototype={peek:function(){if(this.peeked)return this.peeked;var t=this.re.exec(this.str);return t?(this.str=this.str.substr(t[0].length),this.peeked=t[1]):null},peek2:function(){this.peek();var t=this.re.exec(this.str);return t?t[1]:null},pop:function(){var t=this.peek();return this.peeked=null,this.prevprev=this.prev,this.prev=t,t},trypop:function(t){var e=this.peek();if(e===t)return this.pop();if(Array.isArray(t))for(var n=0;n<t.length;++n){var r=t[n];if(r==e)return this.pop()}},trypopfuncname:function(){var t=this.peek();if(!this.isQnameRe.test(t))return null;switch(t){case"comment":case"text":case"processing-instruction":case"node":return null}return"("!=this.peek2()?null:this.pop()},trypopaxisname:function(){var t=this.peek();switch(t){case"ancestor":case"ancestor-or-self":case"attribute":case"child":case"descendant":case"descendant-or-self":case"following":case"following-sibling":case"namespace":case"parent":case"preceding":case"preceding-sibling":case"self":if("::"==this.peek2())return this.pop()}return null},trypopnametest:function(){var t=this.peek();return"*"===t||this.startsWithNcNameRe.test(t)?this.pop():null},trypopliteral:function(){var t=this.peek();if(null==t)return null;var e=t.charAt(0),n=t.charAt(t.length-1);return'"'===e&&'"'===n||"'"===e&&"'"===n?(this.pop(),t.substr(1,t.length-2)):void 0},trypopnumber:function(){var t=this.peek();return this.isNumberRe.test(t)?parseFloat(this.pop()):null},trypopvarref:function(){var t=this.peek();return null==t?null:"$"===t.charAt(0)?this.pop().substr(1):null},position:function(){return this.original.length-this.str.length}},function(){var t="A-Z_a-zÀ-ÖØ-öø-˿Ͱ-ͽͿ-῿‌-‍⁰-↏Ⰰ-⿯、-퟿豈-﷏ﷰ-�",e=t+"\\-\\.0-9·̀-ͯ‿-⁀",n="["+t+"]["+e+"]*",r=n+"(?::"+n+")?",o="\\.\\.|[\\(\\)\\[\\].@,]|::",i="and|or|mod|div|//|!=|<=|>=|[*/|+\\-=<>]",a="\"[^\"]*\"|'[^']*'",u="[0-9]+(?:\\.[0-9]*)?|\\.[0-9]+",s="\\$"+r,c="\\*|"+n+":\\*|"+r,l="[ 	\r\n]*",h=new RegExp("^"+l+"("+u+"|"+o+"|"+c+"|"+i+"|"+a+"|"+s+")");q.prototype.re=h,q.prototype.startsWithNcNameRe=new RegExp("^"+n),q.prototype.isQnameRe=new RegExp("^"+r+"$"),q.prototype.isNumberRe=new RegExp("^"+u+"$")}();var F=H.parse=function(t,e){for(var n,r=d(t,e),o=[];n=t.pop();)o.push(n);if(o.length)throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+t.position()+": Unparsed tokens: "+o.join(" "));return r},V={node:function(){return Array.prototype.slice.call(arguments)}};N.prototype={pushSeries:function(){this.nextPos.push(1),this.seriesIndexes.push(this.nodes.length)},popSeries:function(){console.assert(0<this.nextPos.length,this.nextPos);for(var t=this.nextPos.pop()-1,e=this.nextPos.length,n=this.seriesIndexes.pop(),r=this.nodes.length,o=n;r>o;++o)console.assert(e<this.lasts[o].length),console.assert(void 0===this.lasts[o][e]),this.lasts[o][e]=t},finalize:function(){if(null==this.nextPos)return this;console.assert(0===this.nextPos.length);for(var t=0;t<this.lasts.length;++t)for(var e=0;e<this.lasts[t].length;++e)console.assert(null!=this.lasts[t][e],t+","+e+":"+JSON.stringify(this.lasts));return this.pushSeries=this.popSeries=this.addNode=function(){throw new Error("Already finalized.")},this},addNode:function(t){console.assert(t),this._pushToNodes.call(this.nodes,t),this._pushToNodes.call(this.pos,this.nextPos.slice()),this._pushToNodes.call(this.lasts,new Array(this.nextPos.length));for(var e=0;e<this.nextPos.length;++e)this.nextPos[e]++},simplify:function(){return this.finalize(),{nodes:this.nodes,pos:this.pos,lasts:this.lasts}}},O.prototype={matches:function(t){return(0===this.nodeTypeNum||t.nodeType===this.nodeTypeNum)&&this.nodeNameTest(t.nodeName)},_alwaysTrue:function(){return!0},_nodeNameEquals:function(t){return this.nodeName===t},_nodeNameLowerCaseEquals:function(t){return this.nodeName===t.toLowerCase()}};var Y=H.sortUniqDocumentOrder=function(t){for(var e=[],n=0;n<t.length;n++){var r=t[n],o=C(r);e.push(o)}e.sort(L);for(var i=[],n=0;n<e.length;n++)n>0&&e[n][0]===e[n-1][0]||i.push(e[n][0]);return i},B=H.axes={ancestor:function(t,e,n,r){return S(t,e,n,r,!1)},"ancestor-or-self":function(t,e,n,r){return S(t,e,n,r,!0)},attribute:function(t,e,n,r){var o=new O(e,n,r),i=new N(!1);if(null!=n)for(var a=0;a<t.length;++a){var u=t[a];if(null!=u.getAttributeNode){var s=u.getAttributeNode(n);null!=s&&o.matches(s)&&(i.pushSeries(),i.addNode(s),i.popSeries())}}else for(var a=0;a<t.length;++a){var u=t[a];if(null!=u.attributes){i.pushSeries();for(var c=0;c<u.attributes.length;c++){var s=u.attributes[c];o.matches(s)&&i.addNode(s)}i.popSeries()}}return i.finalize()},child:function J(t,e,n,r){for(var o=new O(e,n,r),i=new N(!1),a=0;a<t.length;++a){var u=t[a];if(!u.ownerElement&&u.childNodes){i.pushSeries();for(var s=1===e&&null!=u.children?u.children:u.childNodes,c=0;c<s.length;++c){var J=s[c];o.matches(J)&&i.addNode(J)}i.popSeries()}}return i.finalize(),j(i)},descendant:function(t,e,n,r){return A(t,e,n,r,!1)},"descendant-or-self":function(t,e,n,r){return A(t,e,n,r,!0)},following:function(t,e,n,r){return R(t,e,n,r)},"following-sibling":function(t,e,n,r){return T(t,e,n,r,Array.prototype.shift,function(){return this[0]},function(t){return t.nextSibling})},namespace:function(){},parent:function te(t,e,n,r){for(var o=new O(e,n,r),i=[],a=[],u=0;u<t.length;++u){var te=t[u].parentNode||t[u].ownerElement;null!=te&&o.matches(te)&&(i.length>0&&te===i[i.length-1]||(i.push(te),a.push([1])))}return{nodes:i,pos:a,lasts:a}},preceding:function(t,e,n,r){return x(t,e,n,r)},"preceding-sibling":function(t,e,n,r){return T(t,e,n,r,Array.prototype.pop,function(){return this[this.length-1]},function(t){return t.previousSibling},!1,!0)},self:function(t,e,n,r){for(var o=[],i=[],a=new O(e,n,r),u=0;u<t.length;++u)a.matches(t[u])&&(o.push(t[u]),i.push([1]));return{nodes:o,pos:i,lasts:i}}},z={number:function(t){return"number"==typeof t?t:"string"==typeof t?parseFloat(t):"boolean"==typeof t?+t:z.number(z.string.call(this,t))},string:function(t){return null==t?z.string(this):"string"==typeof t||"boolean"==typeof t||"number"==typeof t?""+t:0==t.nodes.length?"":null!=t.nodes[0].textContent?t.nodes[0].textContent:t.nodes[0].nodeValue},"boolean":function(t){return"object"==typeof t?t.nodes.length>0:!!t},last:function(){return console.assert(Array.isArray(this.pos)),console.assert(Array.isArray(this.lasts)),console.assert(1===this.pos.length),console.assert(1===this.lasts.length),console.assert(1===this.lasts[0].length),this.lasts[0][0]},position:function(){return console.assert(Array.isArray(this.pos)),console.assert(Array.isArray(this.lasts)),console.assert(1===this.pos.length),console.assert(1===this.lasts.length),console.assert(1===this.pos[0].length),this.pos[0][0]},count:function(t){if("object"!=typeof t)throw new Z(Z.INVALID_EXPRESSION_ERR,"Position "+stream.position()+": Function count(node-set) got wrong argument type: "+t);return t.nodes.length},id:function ee(t){var e={nodes:[]},n=this.nodes[0].ownerDocument||this.nodes[0];console.assert(n);var r;if("object"==typeof t){r=[];for(var o=0;o<t.nodes.length;++o){var i=t.nodes[o],a=z.string({nodes:[i]}),u=a.split(/[ \t\r\n]+/g);Array.prototype.push.apply(r,u)}}else{var a=z.string(t),u=a.split(/[ \t\r\n]+/g);r=u}for(var o=0;o<r.length;++o){var ee=r[o];if(0!==ee.length){var s=n.getElementById(ee);null!=s&&e.nodes.push(s)}}return e.nodes=Y(e.nodes),e},"local-name":function(t){if(null==t)return z.name(this);if(null==t.nodes)throw new Z(Z.INVALID_EXPRESSION_ERR,"argument to name() must be a node-set. got "+t);return t.nodes[0].nodeName.toLowerCase()},"namespace-uri":function(){throw new Error("not implemented yet")},name:function(t){if(null==t)return z.name(this);if(null==t.nodes)throw new Z(Z.INVALID_EXPRESSION_ERR,"argument to name() must be a node-set. got "+t);return t.nodes[0].nodeName.toLowerCase()},concat:function(){for(var t=[],e=0;e<arguments.length;++e)t.push(z.string(arguments[e]));return t.join("")},"starts-with":function(t,e){var n=z.string(t),r=z.string(e);return n.substr(0,r.length)===r},contains:function(t,e){var n=z.string(t),r=z.string(e),o=n.indexOf(r);return-1===o?!1:!0},"substring-before":function(t,e){var n=z.string(t),r=z.string(e),o=n.indexOf(r);return-1===o?"":n.substr(0,o)},"substring-after":function(t,e){var n=z.string(t),r=z.string(e),o=n.indexOf(r);return-1===o?"":n.substr(o+r.length)},substring:function(t,e,n){if(null==t||null==e)throw new Z(Z.INVALID_EXPRESSION_ERR,"Must be at least 2 arguments to string()");var r=z.string(t),o=z.round(e),i=null==n?null:z.round(n);return null==i?r.substr(o-1):r.substr(o-1,i)},"string-length":function(t){return z.string.call(this,t).length},"normalize-space":function(t){var e=z.string.call(this,t);return e.replace(/[ \t\r\n]+/g," ").replace(/^ | $/g,"")},translate:function(t,e,n){for(var r=z.string.call(this,t),o=z.string(e),i=z.string(n),a=[],u={},s=0;s<o.length;++s){var c=o.charAt(s);u[c]=i.charAt(s),a.push(c.replace(/([-()\[\]{}+?*.$\^|,:#<!\\])/g,"\\$1").replace(/\x08/g,"\\x08"))}var l=new RegExp(a.join("|"),"g");return r.replace(l,function(t){return u[t]})},not:function(t){var e=z["boolean"](t);return!e},"true":function(){return!0},"false":function(){return!1},lang:function(){throw new Error("Not implemented")},sum:function ne(t){if(null==t)return z.sum(this);for(var ne=0,e=0;e<t.nodes.length;++e){var n=t.nodes[e],r=z.number({nodes:[n]});ne+=r}return ne},floor:function(t){return Math.floor(z.number(t))},ceiling:function(t){return Math.ceil(z.number(t))},round:function(t){return Math.round(z.number(t))}},G={UnaryMinus:function(t){return-z.number(t)},"+":function(t,e){return z.number(t)+z.number(e)},"-":function(t,e){return z.number(t)-z.number(e)},"*":function(t,e){return z.number(t)*z.number(e)},div:function(t,e){return z.number(t)/z.number(e)},mod:function(t,e){return z.number(t)%z.number(e)},"<":function(t,e){return U(function(t,e){return z.number(t)<z.number(e)},t,e,!0)},"<=":function(t,e){return U(function(t,e){return z.number(t)<=z.number(e)},t,e,!0)},">":function(t,e){return U(function(t,e){return z.number(t)>z.number(e)},t,e,!0)},">=":function(t,e){return U(function(t,e){return z.number(t)>=z.number(e)},t,e,!0)},and:function(t,e){return z["boolean"](t)&&z["boolean"](e)},or:function(t,e){return z["boolean"](t)||z["boolean"](e)},"|":function(t,e){return{nodes:P(t.nodes,e.nodes)}},"=":function(t,e){if("object"==typeof t&&"object"==typeof e){for(var n={},r=0;r<t.nodes.length;++r){var o=z.string({nodes:[t.nodes[r]]});n[o]=!0}for(var r=0;r<e.nodes.length;++r){var o=z.string({nodes:[e.nodes[r]]});if(n[o])return!0}return!1}return U(function(t,e){return t===e},t,e)},"!=":function(t,e){if("object"==typeof t&&"object"==typeof e){if(0===t.nodes.length||0===e.nodes.length)return!1;for(var n={},r=0;r<t.nodes.length;++r){var o=z.string({nodes:[t.nodes[r]]});n[o]=!0}for(var r=0;r<e.nodes.length;++r){var o=z.string({nodes:[e.nodes[r]]});if(!n[o])return!0}return!1}return U(function(t,e){return t!==e},t,e)}},X=H.nodeTypes={node:0,attribute:2,comment:8,text:3,"processing-instruction":7,element:1},W=(H.stringifyObject=function(t){function e(t){if(Array.isArray(t))return t.map(function(t){return e(t)});if("object"!=typeof t)return t;if(null==t)return t;if(null!=t.outerHTML)return t.outerHTML;if(null!=t.nodeValue)return t.nodeName+"="+t.nodeValue;if(t[n])return"[circular]";t[n]=!0;var r={};for(var o in t)if(n!==o)try{r[o]=e(t[o])}catch(i){r[o]="[exception: "+i.message+"]"}return delete t[n],r}var n="seen"+Math.floor(1e9*Math.random());return JSON.stringify(e(t))},H.Evaluator=function(t){this.doc=t});W.prototype={val:function(t,e){if(console.assert(e.nodes),"number"==typeof t||"string"==typeof t)return t;if(G[t[0]]){for(var n=[],r=1;r<t.length;++r)n.push(this.val(t[r],e));var o=G[t[0]].apply(e,n);return o}switch(t[0]){case"Root":return{nodes:[this.doc]};case"FunctionCall":var i=t[1],a=t[2];if(null==z[i])throw new Z(Z.INVALID_EXPRESSION_ERR,"Unknown function: "+i);for(var n=[],r=0;r<a.length;++r)n.push(this.val(a[r],e));var o=z[i].apply(e,n);return o;case"Predicate":for(var u=this.val(t[1],e),s={nodes:[]},c=b(u),r=0;r<c.length;++r){var l,h=c[r],f=this.val(t[2],h);if(l="number"==typeof f?f===h.pos[0][0]:z["boolean"](f)){var p=h.nodes[0];for(s.nodes.push(p);r+1<c.length&&p===c[r+1].nodes[0];)r++}}return s;case"PathExpr":var d=this.val(t[1],e);if(d.finalize){for(var r=0;r<d.nodes.length;++r)console.assert(null!=d.nodes[r].nodeType);return{nodes:d.nodes}}return d;case"/":var u=this.val(t[1],e);console.assert(null!=u);var o=this.val(t[2],u);return console.assert(null!=o),o;case"Axis":var g=t[1],m=t[2],_=X[m],v=!0,E=t[3]&&v?t[3].toLowerCase():t[3];if(E="*"===E?null:E,"object"!=typeof e)return{nodes:[],pos:[]};var y=e.nodes.slice(),o=B[g](y,_,E,v);return o}}};var Z=(H.evaluate=function(t,e,n){var r=new q(t),o=F(r,V),i=new W(e).val(o,{nodes:[n]});return i},H.XPathException=function(t,e){var n=new Error(e);this.__proto__=n,this.name="XPathException",this.code=t});Z.prototype=Error.prototype,Z.prototype.__proto__=Z,Z.INVALID_EXPRESSION_ERR=51,Z.TYPE_ERR=52;var K=H.XPathEvaluator=function(){};K.prototype={createExpression:function(t,e){return new Q(t,e)},createNSResolver:function(){},evaluate:function(t,e,n,r,o){var i=new Q(t,n);return i.evaluate(e,r,o)}};var Q=H.XPathExpression=function(t,e,n){var r=new q(t);this._ast=F(r,V),this._doc=n};Q.prototype={evaluate:function(t,e){if(null==t.nodeType)throw new Error("bad argument (expected context node): "+t);var n=t.ownerDocument||t;if(null!=this._doc&&this._doc!==n)throw new k.DOMException(k.WRONG_DOCUMENT_ERR,"The document must be the same as the context node's document.");var r=new W(n),o=r.val(this._ast,{nodes:[t]});if($.NUMBER_TYPE===e)o=z.number(o);else if($.STRING_TYPE===e)o=z.string(o);else if($.BOOLEAN_TYPE===e)o=z["boolean"](o);else{if($.ANY_TYPE!==e&&$.UNORDERED_NODE_ITERATOR_TYPE!==e&&$.ORDERED_NODE_ITERATOR_TYPE!==e&&$.UNORDERED_NODE_SNAPSHOT_TYPE!==e&&$.ORDERED_NODE_SNAPSHOT_TYPE!==e&&$.ANY_UNORDERED_NODE_TYPE!==e&&$.FIRST_ORDERED_NODE_TYPE!==e)throw new k.DOMException(k.NOT_SUPPORTED_ERR,"You must provide an XPath result type (0=any).");if($.ANY_TYPE!==e&&"object"!=typeof o)throw new Z(Z.TYPE_ERR,"Value should be a node-set: "+o)}return new $(n,o,e)}};var $=H.XPathResult=function re(t,e,n){function r(){o._invalidated=!0,t.removeEventListener("DOMSubtreeModified",r,!0)}if(this._value=e,this._resultType=n,this._i=0,this._invalidated=!1,this.resultType===re.UNORDERED_NODE_ITERATOR_TYPE||this.resultType===re.ORDERED_NODE_ITERATOR_TYPE){t.addEventListener("DOMSubtreeModified",r,!0);var o=this}};$.ANY_TYPE=0,$.NUMBER_TYPE=1,$.STRING_TYPE=2,$.BOOLEAN_TYPE=3,$.UNORDERED_NODE_ITERATOR_TYPE=4,$.ORDERED_NODE_ITERATOR_TYPE=5,$.UNORDERED_NODE_SNAPSHOT_TYPE=6,$.ORDERED_NODE_SNAPSHOT_TYPE=7,$.ANY_UNORDERED_NODE_TYPE=8,$.FIRST_ORDERED_NODE_TYPE=9,$.prototype={get resultType(){if(this._resultType)return this._resultType;switch(typeof this._value){case"number":return $.NUMBER_TYPE;case"string":return $.STRING_TYPE;case"boolean":return $.BOOLEAN_TYPE;default:return $.UNORDERED_NODE_ITERATOR_TYPE}},get numberValue(){if($.NUMBER_TYPE!==this.resultType)throw new Z(Z.TYPE_ERR,"You should have asked for a NUMBER_TYPE.");return this._value},get stringValue(){if($.STRING_TYPE!==this.resultType)throw new Z(Z.TYPE_ERR,"You should have asked for a STRING_TYPE.");return this._value},get booleanValue(){if($.BOOLEAN_TYPE!==this.resultType)throw new Z(Z.TYPE_ERR,"You should have asked for a BOOLEAN_TYPE.");return this._value},get singleNodeValue(){if($.ANY_UNORDERED_NODE_TYPE!==this.resultType&&$.FIRST_ORDERED_NODE_TYPE!==this.resultType)throw new Z(Z.TYPE_ERR,"You should have asked for a FIRST_ORDERED_NODE_TYPE.");return this._value.nodes[0]||null},get invalidIteratorState(){return $.UNORDERED_NODE_ITERATOR_TYPE!==this.resultType&&$.ORDERED_NODE_ITERATOR_TYPE!==this.resultType?!1:!!this._invalidated},get snapshotLength(){if($.UNORDERED_NODE_SNAPSHOT_TYPE!==this.resultType&&$.ORDERED_NODE_SNAPSHOT_TYPE!==this.resultType)throw new Z(Z.TYPE_ERR,"You should have asked for a ORDERED_NODE_SNAPSHOT_TYPE.");return this._value.nodes.length},iterateNext:function(){if($.UNORDERED_NODE_ITERATOR_TYPE!==this.resultType&&$.ORDERED_NODE_ITERATOR_TYPE!==this.resultType)throw new Z(Z.TYPE_ERR,"You should have asked for a ORDERED_NODE_ITERATOR_TYPE.");if(this.invalidIteratorState)throw new k.DOMException(k.INVALID_STATE_ERR,"The document has been mutated since the result was returned");return this._value.nodes[this._i++]||null},snapshotItem:function(t){if($.UNORDERED_NODE_SNAPSHOT_TYPE!==this.resultType&&$.ORDERED_NODE_SNAPSHOT_TYPE!==this.resultType)throw new Z(Z.TYPE_ERR,"You should have asked for a ORDERED_NODE_SNAPSHOT_TYPE.");return this._value.nodes[t]||null}},$.prototype.__proto__=$,k.XPathException=Z,k.XPathExpression=Q,k.XPathResult=$,k.XPathEvaluator=K,k.Document.prototype.createExpression=K.prototype.createExpression,k.Document.prototype.createNSResolver=K.prototype.createNSResolver,k.Document.prototype.evaluate=K.prototype.evaluate}();
//# sourceMappingURL=jspm_packages/npm/jsdom@0.5.7/level3/xpath.js.map