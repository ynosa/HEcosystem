function safeStringify(e){var t;try{t=JSON.stringify(e)}catch(n){t=_safeStringify(e)}return t}function isReadStream(e){return e.readable&&e.path&&e.mode}function toBase64(e){return new Buffer(e||"","ascii").toString("base64")}function md5(e){return crypto.createHash("md5").update(e).digest("hex")}function Request(e){stream.Stream.call(this),this.readable=!0,this.writable=!0,"string"==typeof e&&(e={uri:e});var t=Object.keys(Request.prototype);for(var n in e)-1===t.indexOf(n)?this[n]=e[n]:"function"==typeof e[n]&&delete e[n];e.method&&(this.explicitMethod=!0),this.canTunnel=e.tunnel!==!1&&tunnel,this.init(e)}function toJSON(){return getSafe(this,"__"+(65536*(1+Math.random())|0).toString(16))}var optional=require("./lib/optional"),http=require("github:jspm/nodelibs@0.0.2/http"),https=optional("https"),tls=optional("tls"),url=require("github:jspm/nodelibs@0.0.2/url"),util=require("github:jspm/nodelibs@0.0.2/util"),stream=require("github:jspm/nodelibs@0.0.2/stream"),qs=require("qs"),querystring=require("github:jspm/nodelibs@0.0.2/querystring"),crypto=require("crypto"),oauth=optional("oauth-sign"),hawk=optional("hawk"),aws=optional("aws-sign2"),httpSignature=optional("http-signature"),uuid=require("node-uuid"),mime=require("mime"),tunnel=optional("tunnel-agent"),_safeStringify=require("json-stringify-safe"),ForeverAgent=require("forever-agent"),FormData=optional("form-data"),cookies=require("./lib/cookies"),globalCookieJar=cookies.jar(),copy=require("./lib/copy"),debug=require("./lib/debug"),getSafe=require("./lib/getSafe"),net=require("net"),globalPool={},isUrl=/^https?:|^unix:/;https&&!https.Agent&&(https.Agent=function(e){http.Agent.call(this,e)},util.inherits(https.Agent,http.Agent),https.Agent.prototype._getConnection=function(e,t,n){var r=tls.connect(t,e,this.options,function(){n&&n()});return r}),util.inherits(Request,stream.Stream),Request.prototype.init=function(e){var t=this;if(e||(e={}),t.method||(t.method=e.method||"GET"),t.localAddress=e.localAddress,debug(e),t.pool||t.pool===!1||(t.pool=globalPool),t.dests=t.dests||[],t.__isRequestRequest=!0,!t._callback&&t.callback&&(t._callback=t.callback,t.callback=function(){t._callbackCalled||(t._callbackCalled=!0,t._callback.apply(t,arguments))},t.on("error",t.callback.bind()),t.on("complete",t.callback.bind(t,null))),t.url&&!t.uri&&(t.uri=t.url,delete t.url),!t.uri)return t.emit("error",new Error("options.uri is a required argument"));if("string"==typeof t.uri&&(t.uri=url.parse(t.uri)),t.strictSSL===!1&&(t.rejectUnauthorized=!1),t.proxy&&("string"==typeof t.proxy&&(t.proxy=url.parse(t.proxy)),http.globalAgent&&"https:"===t.uri.protocol&&t.canTunnel)){var n="http:"===t.proxy.protocol?tunnel.httpsOverHttp:tunnel.httpsOverHttps,o={proxy:{host:t.proxy.hostname,port:+t.proxy.port,proxyAuth:t.proxy.auth,headers:{Host:t.uri.hostname+":"+(t.uri.port||"https:"===t.uri.protocol?443:80)}},rejectUnauthorized:t.rejectUnauthorized,ca:this.ca};t.agent=n(o),t.tunnel=!0}if(t.uri.pathname||(t.uri.pathname="/"),!t.uri.host&&"unix:"==!t.protocol){var i=url.format(t.uri),a='Invalid URI "'+i+'"';return 0===Object.keys(e).length&&(a+=". This can be caused by a crappy redirection."),void t.emit("error",new Error(a))}t._redirectsFollowed=t._redirectsFollowed||0,t.maxRedirects=void 0!==t.maxRedirects?t.maxRedirects:10,t.followRedirect=void 0!==t.followRedirect?t.followRedirect:!0,t.followAllRedirects=void 0!==t.followAllRedirects?t.followAllRedirects:!1,(t.followRedirect||t.followAllRedirects)&&(t.redirects=t.redirects||[]),t.headers=t.headers?copy(t.headers):{},t.setHost=!1,t.hasHeader("host")||(t.setHeader("host",t.uri.hostname),t.uri.port&&(80===t.uri.port&&"http:"===t.uri.protocol||443===t.uri.port&&"https:"===t.uri.protocol||t.setHeader("host",t.getHeader("host")+(":"+t.uri.port))),t.setHost=!0),t.jar(t._jar||e.jar),t.uri.port||("http:"==t.uri.protocol?t.uri.port=80:"https:"==t.uri.protocol&&(t.uri.port=443)),t.proxy&&!t.tunnel?(t.port=t.proxy.port,t.host=t.proxy.hostname):(t.port=t.uri.port,t.host=t.uri.hostname),t.clientErrorHandler=function(e){if(!t._aborted){if(t.req&&t.req._reusedSocket&&"ECONNRESET"===e.code&&t.agent.addRequestNoreuse)return t.agent={addRequest:t.agent.addRequestNoreuse.bind(t.agent)},t.start(),void t.req.end();t.timeout&&t.timeoutTimer&&(clearTimeout(t.timeoutTimer),t.timeoutTimer=null),t.emit("error",e)}},t._parserErrorHandler=function(e){this.res?this.res.request?this.res.request.emit("error",e):this.res.emit("error",e):this._httpMessage.emit("error",e)},t._buildRequest=function(){var t=this;if(e.form&&t.form(e.form),e.qs&&t.qs(e.qs),t.path=t.uri.path?t.uri.path:t.uri.pathname+(t.uri.search||""),0===t.path.length&&(t.path="/"),e.oauth&&t.oauth(e.oauth),e.aws&&t.aws(e.aws),e.hawk&&t.hawk(e.hawk),e.httpSignature&&t.httpSignature(e.httpSignature),e.auth&&(Object.prototype.hasOwnProperty.call(e.auth,"username")&&(e.auth.user=e.auth.username),Object.prototype.hasOwnProperty.call(e.auth,"password")&&(e.auth.pass=e.auth.password),t.auth(e.auth.user,e.auth.pass,e.auth.sendImmediately)),t.uri.auth&&!t.hasHeader("authorization")){var n=t.uri.auth.split(":").map(function(e){return querystring.unescape(e)});t.auth(n[0],n.slice(1).join(":"),!0)}if(t.proxy&&t.proxy.auth&&!t.hasHeader("proxy-authorization")&&!t.tunnel&&t.setHeader("proxy-authorization","Basic "+toBase64(t.proxy.auth.split(":").map(function(e){return querystring.unescape(e)}).join(":"))),t.proxy&&!t.tunnel&&(t.path=t.uri.protocol+"//"+t.uri.host+t.path),e.json?t.json(e.json):e.multipart&&(t.boundary=uuid(),t.multipart(e.multipart)),t.body){var r=0;if(Buffer.isBuffer(t.body))r=t.body.length;else if(Array.isArray(t.body))for(var o=0;o<t.body.length;o++)r+=t.body[o].length;else t.body=new Buffer(t.body),r=t.body.length;if(!r)throw new Error("Argument error, options.body.");t.hasHeader("content-length")||t.setHeader("content-length",r)}var i=t.proxy&&!t.tunnel?t.proxy.protocol:t.uri.protocol,a={"http:":http,"https:":https,"unix:":http},s=t.httpModules||{};return t.httpModule=s[i]||a[i],t.httpModule?(e.ca&&(t.ca=e.ca),t.agent||(e.agentOptions&&(t.agentOptions=e.agentOptions),t.agentClass=e.agentClass?e.agentClass:e.forever?"http:"===i?ForeverAgent:ForeverAgent.SSL:t.httpModule.Agent),t.pool===!1?t.agent=!1:(t.agent=t.agent||t.getAgent(),t.maxSockets&&(t.agent.maxSockets=t.maxSockets),t.pool.maxSockets&&(t.agent.maxSockets=t.pool.maxSockets)),t.on("pipe",function(e){if(t.ntick&&t._started)throw new Error("You cannot pipe to this stream after the outbound request has started.");if(t.src=e,isReadStream(e))t.hasHeader("content-type")||t.setHeader("content-type",mime.lookup(e.path));else{if(e.headers)for(var n in e.headers)t.hasHeader(n)||t.setHeader(n,e.headers[n]);t._json&&!t.hasHeader("content-type")&&t.setHeader("content-type","application/json"),e.method&&!t.explicitMethod&&(t.method=e.method)}}),void process.nextTick(function(){if(!t._aborted){if(t._form){t.setHeaders(t._form.getHeaders());try{var e=t._form.getLengthSync();t.setHeader("content-length",e)}catch(n){}t._form.pipe(t)}t.body?(Array.isArray(t.body)?t.body.forEach(function(e){t.write(e)}):t.write(t.body),t.end()):t.requestBodyStream?(console.warn("options.requestBodyStream is deprecated, please pass the request object to stream.pipe."),t.requestBodyStream.pipe(t)):t.src||("GET"!==t.method&&"undefined"!=typeof t.method&&t.setHeader("content-length",0),t.end()),t.ntick=!0}})):this.emit("error",new Error("Invalid protocol"))},t._handleUnixSocketURI=function(e){function t(e){var t=net.connect(e);t.path=e,t.on("error",function(){s[this.path].error_connecting=!0,this.end()}),t.on("connect",function(){s[this.path].error_connecting=!1,this.end()}),e.client=t}function n(){var e;(e="undefined"==typeof setImmediate?process.nextTick:setImmediate)(function(){response_counter++;var e=!1;for(r in s)"undefined"==typeof s[r].error_connecting&&(e=!0);e&&1e3>response_counter?n():o()})}function o(){var t;for(r in s)s[r].error_connecting===!1&&(t=r);t||e.emit("error",new Error("Failed to connect to any socket in "+i));var n=i.replace(t,"");e.socketPath=t,e.uri.pathname=n,e.uri.href=n,e.uri.path=n,e.host="",e.hostname="",delete e.host,delete e.hostname,e._buildRequest()}e.unixsocket=!0;var i=e.uri.href.replace(e.uri.protocol+"/",""),a=i.split("/"),s={};do s[a.join("/")]={};while(a.pop());for(r in s)t(r);n(),response_counter=0},/^unix:/.test(t.uri.protocol)?t._handleUnixSocketURI(t):t._buildRequest()},Request.prototype._updateProtocol=function(){var e=this,t=e.uri.protocol;if("https:"===t){if(e.proxy&&e.canTunnel){e.tunnel=!0;var n="http:"===e.proxy.protocol?tunnel.httpsOverHttp:tunnel.httpsOverHttps,r={proxy:{host:e.proxy.hostname,port:+e.proxy.port,proxyAuth:e.proxy.auth},rejectUnauthorized:e.rejectUnauthorized,ca:e.ca};return void(e.agent=n(r))}switch(e.httpModule=https,e.agentClass){case ForeverAgent:e.agentClass=ForeverAgent.SSL;break;case http.Agent:e.agentClass=https.Agent;break;default:return}e.agent&&(e.agent=e.getAgent())}else{switch(e.tunnel&&(e.tunnel=!1),e.httpModule=http,e.agentClass){case ForeverAgent.SSL:e.agentClass=ForeverAgent;break;case https.Agent:e.agentClass=http.Agent;break;default:return}e.agent&&(e.agent=null,e.agent=e.getAgent())}},Request.prototype.getAgent=function(){var e=this.agentClass,t={};if(this.agentOptions)for(var n in this.agentOptions)t[n]=this.agentOptions[n];this.ca&&(t.ca=this.ca),this.ciphers&&(t.ciphers=this.ciphers),this.secureProtocol&&(t.secureProtocol=this.secureProtocol),"undefined"!=typeof this.rejectUnauthorized&&(t.rejectUnauthorized=this.rejectUnauthorized),this.cert&&this.key&&(t.key=this.key,t.cert=this.cert);var r="";e!==this.httpModule.Agent&&(r+=e.name),this.httpModule.globalAgent||(t.host=this.host,t.port=this.port,r&&(r+=":"),r+=this.host+":"+this.port);var o=this.proxy;"string"==typeof o&&(o=url.parse(o));var i=o&&"https:"===o.protocol||"https:"===this.uri.protocol;return i&&(t.ca&&(r&&(r+=":"),r+=t.ca),"undefined"!=typeof t.rejectUnauthorized&&(r&&(r+=":"),r+=t.rejectUnauthorized),t.cert&&(r+=t.cert.toString("ascii")+t.key.toString("ascii")),t.ciphers&&(r&&(r+=":"),r+=t.ciphers),t.secureProtocol&&(r&&(r+=":"),r+=t.secureProtocol)),this.pool===globalPool&&!r&&0===Object.keys(t).length&&this.httpModule.globalAgent?this.httpModule.globalAgent:(r=this.uri.protocol+r,this.pool[r]?this.pool[r]:this.pool[r]=new e(t))},Request.prototype.start=function(){var e=this;if(!e._aborted){e._started=!0,e.method=e.method||"GET",e.href=e.uri.href,e.src&&e.src.stat&&e.src.stat.size&&!e.hasHeader("content-length")&&e.setHeader("content-length",e.src.stat.size),e._aws&&e.aws(e._aws,!0);var t=copy(e);delete t.auth,debug("make request",e.uri.href),e.req=e.httpModule.request(t,e.onResponse.bind(e)),e.timeout&&!e.timeoutTimer&&(e.timeoutTimer=setTimeout(function(){e.req.abort();var t=new Error("ETIMEDOUT");t.code="ETIMEDOUT",e.emit("error",t)},e.timeout),e.req.setTimeout&&e.req.setTimeout(e.timeout,function(){if(e.req){e.req.abort();var t=new Error("ESOCKETTIMEDOUT");t.code="ESOCKETTIMEDOUT",e.emit("error",t)}})),e.req.on("error",e.clientErrorHandler),e.req.on("drain",function(){e.emit("drain")}),e.on("end",function(){e.req.connection&&e.req.connection.removeListener("error",e._parserErrorHandler)}),e.emit("request",e.req)}},Request.prototype.onResponse=function(e){var t=this;if(debug("onResponse",t.uri.href,e.statusCode,e.headers),e.on("end",function(){debug("response end",t.uri.href,e.statusCode,e.headers)}),-1===e.connection.listeners("error").indexOf(t._parserErrorHandler)&&e.connection.once("error",t._parserErrorHandler),t._aborted)return debug("aborted",t.uri.href),void e.resume();if(t._paused?e.pause():e.resume(),t.response=e,e.request=t,e.toJSON=toJSON,t.httpModule===https&&t.strictSSL&&!e.client.authorized){debug("strict ssl error",t.uri.href);var n=e.client.authorizationError;return void t.emit("error",new Error("SSL Error: "+n))}t.setHost&&t.hasHeader("host")&&delete t.headers[t.hasHeader("host")],t.timeout&&t.timeoutTimer&&(clearTimeout(t.timeoutTimer),t.timeoutTimer=null);var r=t._jar&&t._jar.setCookie?t._jar:globalCookieJar,o=function(e){try{r.setCookie(e,t.uri.href,{ignoreError:!0})}catch(n){t.emit("error",n)}};if(hasHeader("set-cookie",e.headers)&&!t._disableCookies){var i=hasHeader("set-cookie",e.headers);Array.isArray(e.headers[i])?e.headers[i].forEach(o):o(e.headers[i])}var a=null;if(e.statusCode>=300&&e.statusCode<400&&hasHeader("location",e.headers)){var s=e.headers[hasHeader("location",e.headers)];if(debug("redirect",s),t.followAllRedirects)a=s;else if(t.followRedirect)switch(t.method){case"PATCH":case"PUT":case"POST":case"DELETE":break;default:a=s}}else if(401==e.statusCode&&t._hasAuth&&!t._sentAuth){var u=e.headers[hasHeader("www-authenticate",e.headers)],c=u&&u.split(" ")[0].toLowerCase();switch(debug("reauth",c),c){case"basic":t.auth(t._user,t._pass,!0),a=t.uri;break;case"digest":for(var l={},h=/([a-z0-9_-]+)=(?:"([^"]+)"|([a-z0-9_-]+))/gi;;){var f=h.exec(u);if(!f)break;l[f[1]]=f[2]||f[3]}var p=md5(t._user+":"+l.realm+":"+t._pass),d=md5(t.method+":"+t.uri.path),m=/(^|,)\s*auth\s*($|,)/.test(l.qop)&&"auth",g=m&&"00000001",y=m&&uuid().replace(/-/g,""),_=md5(m?p+":"+l.nonce+":"+g+":"+y+":"+m+":"+d:p+":"+l.nonce+":"+d),v={username:t._user,realm:l.realm,nonce:l.nonce,uri:t.uri.path,qop:m,response:_,nc:g,cnonce:y,algorithm:l.algorithm,opaque:l.opaque};u=[];for(var E in v)v[E]&&u.push("qop"===E||"nc"===E||"algorithm"===E?E+"="+v[E]:E+'="'+v[E]+'"');u="Digest "+u.join(", "),t.setHeader("authorization",u),t._sentAuth=!0,a=t.uri}}if(a){if(debug("redirect to",a),t._paused&&e.resume(),t._redirectsFollowed>=t.maxRedirects)return void t.emit("error",new Error("Exceeded maxRedirects. Probably stuck in a redirect loop "+t.uri.href));t._redirectsFollowed+=1,isUrl.test(a)||(a=url.resolve(t.uri.href,a));var b=t.uri;return t.uri=url.parse(a),t.uri.protocol!==b.protocol&&t._updateProtocol(),t.redirects.push({statusCode:e.statusCode,redirectUri:a}),t.followAllRedirects&&401!=e.statusCode&&(t.method="GET"),delete t.src,delete t.req,delete t.agent,delete t._started,401!=e.statusCode&&(delete t.body,delete t._form,t.headers&&(t.hasHeader("host")&&delete t.headers[t.hasHeader("host")],t.hasHeader("content-type")&&delete t.headers[t.hasHeader("content-type")],t.hasHeader("content-length")&&delete t.headers[t.hasHeader("content-length")])),t.emit("redirect"),void t.init()}if(t._redirectsFollowed=t._redirectsFollowed||0,e.on("close",function(){t._ended||t.response.emit("end")}),t.encoding&&(0!==t.dests.length?console.error("Ignoring encoding parameter as this stream is being piped to another stream which makes the encoding option invalid."):e.setEncoding(t.encoding)),t.emit("response",e),t.dests.forEach(function(e){t.pipeDest(e)}),e.on("data",function(e){t._destdata=!0,t.emit("data",e)}),e.on("end",function(e){t._ended=!0,t.emit("end",e)}),e.on("close",function(){t.emit("close")}),t.callback){var N=[],S=0;t.on("data",function(e){N.push(e),S+=e.length}),t.on("end",function(){if(debug("end event",t.uri.href),t._aborted)return void debug("aborted",t.uri.href);if(N.length&&Buffer.isBuffer(N[0])){debug("has body",t.uri.href,S);var n=new Buffer(S),r=0;N.forEach(function(e){e.copy(n,r,0,e.length),r+=e.length}),e.body=null===t.encoding?n:n.toString(t.encoding)}else N.length&&("utf8"===t.encoding&&N[0].length>0&&"﻿"===N[0][0]&&(N[0]=N[0].substring(1)),e.body=N.join(""));if(t._json)try{e.body=JSON.parse(e.body)}catch(o){}debug("emitting complete",t.uri.href),void 0!=e.body||t._json||(e.body=""),t.emit("complete",e,e.body)})}else t.on("end",function(){return t._aborted?void debug("aborted",t.uri.href):void t.emit("complete",e)});debug("finish init function",t.uri.href)},Request.prototype.abort=function(){this._aborted=!0,this.req?this.req.abort():this.response&&this.response.abort(),this.emit("abort")},Request.prototype.pipeDest=function(e){var t=this.response;if(e.headers&&!e.headersSent){if(hasHeader("content-type",t.headers)){var n=hasHeader("content-type",t.headers);e.setHeader?e.setHeader(n,t.headers[n]):e.headers[n]=t.headers[n]}if(hasHeader("content-length",t.headers)){var r=hasHeader("content-length",t.headers);e.setHeader?e.setHeader(r,t.headers[r]):e.headers[r]=t.headers[r]}}if(e.setHeader&&!e.headersSent){for(var o in t.headers)e.setHeader(o,t.headers[o]);e.statusCode=t.statusCode}this.pipefilter&&this.pipefilter(t,e)},Request.prototype.setHeader=function(e,t,n){return void 0===n&&(n=!0),n||!this.hasHeader(e)?this.headers[e]=t:this.headers[this.hasHeader(e)]+=","+t,this},Request.prototype.setHeaders=function(e){for(var t in e)this.setHeader(t,e[t]);return this},Request.prototype.hasHeader=function(e,t){var t=Object.keys(t||this.headers),n=t.map(function(e){return e.toLowerCase()});e=e.toLowerCase();for(var r=0;r<n.length;r++)if(n[r]===e)return t[r];return!1};var hasHeader=Request.prototype.hasHeader;Request.prototype.qs=function(e,t){var n;n=!t&&this.uri.query?qs.parse(this.uri.query):{};for(var r in e)n[r]=e[r];return""===qs.stringify(n)?this:(this.uri=url.parse(this.uri.href.split("?")[0]+"?"+qs.stringify(n)),this.url=this.uri,this.path=this.uri.path,this)},Request.prototype.form=function(e){return e?(this.setHeader("content-type","application/x-www-form-urlencoded; charset=utf-8"),this.body=qs.stringify(e).toString("utf8"),this):(this._form=new FormData,this._form)},Request.prototype.multipart=function(e){var t=this;if(t.body=[],t.hasHeader("content-type")){var n=t.hasHeader("content-type");t.setHeader(n,t.headers[n].split(";")[0]+"; boundary="+t.boundary)}else t.setHeader("content-type","multipart/related; boundary="+t.boundary);if(!e.forEach)throw new Error("Argument error, options.multipart.");return t.preambleCRLF&&t.body.push(new Buffer("\r\n")),e.forEach(function(e){var n=e.body;if(null==n)throw Error("Body attribute missing in multipart.");delete e.body;var r="--"+t.boundary+"\r\n";Object.keys(e).forEach(function(t){r+=t+": "+e[t]+"\r\n"}),r+="\r\n",t.body.push(new Buffer(r)),t.body.push(new Buffer(n)),t.body.push(new Buffer("\r\n"))}),t.body.push(new Buffer("--"+t.boundary+"--")),t},Request.prototype.json=function(e){var t=this;return t.hasHeader("accept")||t.setHeader("accept","application/json"),this._json=!0,"boolean"==typeof e?"object"==typeof this.body&&(this.body=safeStringify(this.body),t.hasHeader("content-type")||t.setHeader("content-type","application/json")):(this.body=safeStringify(e),t.hasHeader("content-type")||t.setHeader("content-type","application/json")),this},Request.prototype.getHeader=function(e,t){var n,r,o;return t||(t=this.headers),Object.keys(t).forEach(function(i){r=new RegExp(e,"i"),o=i.match(r),o&&(n=t[i])}),n};var getHeader=Request.prototype.getHeader;Request.prototype.auth=function(e,t,n){if("string"!=typeof e||void 0!==t&&"string"!=typeof t)throw new Error("auth() received invalid user or password");this._user=e,this._pass=t,this._hasAuth=!0;var r="undefined"!=typeof t?e+":"+t:e;return(n||"undefined"==typeof n)&&(this.setHeader("authorization","Basic "+toBase64(r)),this._sentAuth=!0),this},Request.prototype.aws=function(e,t){if(!t)return this._aws=e,this;var n=new Date;this.setHeader("date",n.toUTCString());var r={key:e.key,secret:e.secret,verb:this.method.toUpperCase(),date:n,contentType:this.getHeader("content-type")||"",md5:this.getHeader("content-md5")||"",amazonHeaders:aws.canonicalizeHeaders(this.headers)};return e.bucket&&this.path?r.resource="/"+e.bucket+this.path:e.bucket&&!this.path?r.resource="/"+e.bucket:!e.bucket&&this.path?r.resource=this.path:e.bucket||this.path||(r.resource="/"),r.resource=aws.canonicalizeResource(r.resource),this.setHeader("authorization",aws.authorization(r)),this},Request.prototype.httpSignature=function(e){var t=this;return httpSignature.signRequest({getHeader:function(e){return getHeader(e,t.headers)},setHeader:function(e,n){t.setHeader(e,n)},method:this.method,path:this.path},e),debug("httpSignature authorization",this.getHeader("authorization")),this},Request.prototype.hawk=function(e){this.setHeader("Authorization",hawk.client.header(this.uri,this.method,e).field)},Request.prototype.oauth=function(e){var t;this.hasHeader("content-type")&&"application/x-www-form-urlencoded"===this.getHeader("content-type").slice(0,"application/x-www-form-urlencoded".length)&&(t=qs.parse(this.body)),this.uri.query&&(t=qs.parse(this.uri.query)),t||(t={});var n={};for(var r in t)n[r]=t[r];for(var r in e)n["oauth_"+r]=e[r];n.oauth_version||(n.oauth_version="1.0"),n.oauth_timestamp||(n.oauth_timestamp=Math.floor(Date.now()/1e3).toString()),n.oauth_nonce||(n.oauth_nonce=uuid().replace(/-/g,"")),n.oauth_signature_method="HMAC-SHA1";var o=n.oauth_consumer_secret;delete n.oauth_consumer_secret;var i=n.oauth_token_secret;delete n.oauth_token_secret;var a=n.oauth_timestamp,s=this.uri.protocol+"//"+this.uri.host+this.uri.pathname,u=oauth.hmacsign(this.method,s,n,o,i);for(var r in t)r.slice(0,"oauth_")in e||(delete n["oauth_"+r],"x_auth_mode"!==r&&delete n[r]);n.oauth_timestamp=a;var c="OAuth "+Object.keys(n).sort().map(function(e){return e+'="'+oauth.rfc3986(n[e])+'"'}).join(",");return c+=',oauth_signature="'+oauth.rfc3986(u)+'"',this.setHeader("Authorization",c),this},Request.prototype.jar=function(e){var t;if(0===this._redirectsFollowed&&(this.originalCookieHeader=this.getHeader("cookie")),e){var n=e&&e.getCookieString?e:globalCookieJar,r=this.uri.href;n&&(t=n.getCookieString(r))}else t=!1,this._disableCookies=!0;return t&&t.length&&(this.originalCookieHeader?this.setHeader("cookie",this.originalCookieHeader+"; "+t):this.setHeader("cookie",t)),this._jar=e,this},Request.prototype.pipe=function(e,t){if(this.response){if(this._destdata)throw new Error("You cannot pipe after data has been emitted from the response.");if(this._ended)throw new Error("You cannot pipe after the response has been ended.");return stream.Stream.prototype.pipe.call(this,e,t),this.pipeDest(e),e}return this.dests.push(e),stream.Stream.prototype.pipe.call(this,e,t),e},Request.prototype.write=function(){return this._started||this.start(),this.req.write.apply(this.req,arguments)},Request.prototype.end=function(e){e&&this.write(e),this._started||this.start(),this.req.end()},Request.prototype.pause=function(){this.response?this.response.pause.apply(this.response,arguments):this._paused=!0},Request.prototype.resume=function(){this.response?this.response.resume.apply(this.response,arguments):this._paused=!1},Request.prototype.destroy=function(){this._ended?this.response&&this.response.destroy():this.end()},Request.prototype.toJSON=toJSON,module.exports=Request;
//# sourceMappingURL=jspm_packages/npm/request@2.34.0/request.js.map