// Copyright Joyent, Inc. and other Node contributors.
function ReadableState(t){t=t||{};var e=t.highWaterMark;this.highWaterMark=e||0===e?e:16384,this.highWaterMark=~~this.highWaterMark,this.buffer=[],this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=!1,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.calledRead=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.objectMode=!!t.objectMode,this.defaultEncoding=t.defaultEncoding||"utf8",this.ranOut=!1,this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,t.encoding&&(StringDecoder||(StringDecoder=require("../string_decoder").StringDecoder),this.decoder=new StringDecoder(t.encoding),this.encoding=t.encoding)}function Readable(t){return this instanceof Readable?(this._readableState=new ReadableState(t,this),this.readable=!0,void Stream.call(this)):new Readable(t)}function readableAddChunk(t,e,n,r,i){var o=chunkInvalid(e,n);if(o)t.emit("error",o);else if(null===n||void 0===n)e.reading=!1,e.ended||onEofChunk(t,e);else if(e.objectMode||n&&n.length>0)if(e.ended&&!i){var a=new Error("stream.push() after EOF");t.emit("error",a)}else if(e.endEmitted&&i){var a=new Error("stream.unshift() after end event");t.emit("error",a)}else!e.decoder||i||r||(n=e.decoder.write(n)),e.length+=e.objectMode?1:n.length,i?e.buffer.unshift(n):(e.reading=!1,e.buffer.push(n)),e.needReadable&&emitReadable(t),maybeReadMore(t,e);else i||(e.reading=!1);return needMoreData(e)}function needMoreData(t){return!t.ended&&(t.needReadable||t.length<t.highWaterMark||0===t.length)}function roundUpToNextPowerOf2(t){if(t>=MAX_HWM)t=MAX_HWM;else{t--;for(var e=1;32>e;e<<=1)t|=t>>e;t++}return t}function howMuchToRead(t,e){return 0===e.length&&e.ended?0:e.objectMode?0===t?0:1:isNaN(t)||null===t?e.flowing&&e.buffer.length?e.buffer[0].length:e.length:0>=t?0:(t>e.highWaterMark&&(e.highWaterMark=roundUpToNextPowerOf2(t)),t>e.length?e.ended?e.length:(e.needReadable=!0,0):t)}function chunkInvalid(t,e){var n=null;return Buffer.isBuffer(e)||"string"==typeof e||null===e||void 0===e||t.objectMode||n||(n=new TypeError("Invalid non-string/buffer chunk")),n}function onEofChunk(t,e){if(e.decoder&&!e.ended){var n=e.decoder.end();n&&n.length&&(e.buffer.push(n),e.length+=e.objectMode?1:n.length)}e.ended=!0,e.length>0?emitReadable(t):endReadable(t)}function emitReadable(t){var e=t._readableState;e.needReadable=!1,e.emittedReadable||(e.emittedReadable=!0,e.sync?setImmediate(function(){emitReadable_(t)}):emitReadable_(t))}function emitReadable_(t){t.emit("readable")}function maybeReadMore(t,e){e.readingMore||(e.readingMore=!0,setImmediate(function(){maybeReadMore_(t,e)}))}function maybeReadMore_(t,e){for(var n=e.length;!e.reading&&!e.flowing&&!e.ended&&e.length<e.highWaterMark&&(t.read(0),n!==e.length);)n=e.length;e.readingMore=!1}function pipeOnDrain(t){return function(){var e=t._readableState;e.awaitDrain--,0===e.awaitDrain&&flow(t)}}function flow(t){function e(t){var e=t.write(n);!1===e&&r.awaitDrain++}var n,r=t._readableState;for(r.awaitDrain=0;r.pipesCount&&null!==(n=t.read());)if(1===r.pipesCount?e(r.pipes,0,null):forEach(r.pipes,e),t.emit("data",n),r.awaitDrain>0)return;return 0===r.pipesCount?(r.flowing=!1,void(EE.listenerCount(t,"data")>0&&emitDataEvents(t))):void(r.ranOut=!0)}function pipeOnReadable(){this._readableState.ranOut&&(this._readableState.ranOut=!1,flow(this))}function emitDataEvents(t,e){var n=t._readableState;if(n.flowing)throw new Error("Cannot switch to old mode now.");var r=e||!1,i=!1;t.readable=!0,t.pipe=Stream.prototype.pipe,t.on=t.addListener=Stream.prototype.on,t.on("readable",function(){i=!0;for(var e;!r&&null!==(e=t.read());)t.emit("data",e);null===e&&(i=!1,t._readableState.needReadable=!0)}),t.pause=function(){r=!0,this.emit("pause")},t.resume=function(){r=!1,i?setImmediate(function(){t.emit("readable")}):this.read(0),this.emit("resume")},t.emit("readable")}function fromList(t,e){var n,r=e.buffer,i=e.length,o=!!e.decoder,a=!!e.objectMode;if(0===r.length)return null;if(0===i)n=null;else if(a)n=r.shift();else if(!t||t>=i)n=o?r.join(""):Buffer.concat(r,i),r.length=0;else if(t<r[0].length){var s=r[0];n=s.slice(0,t),r[0]=s.slice(t)}else if(t===r[0].length)n=r.shift();else{n=o?"":new Buffer(t);for(var u=0,f=0,l=r.length;l>f&&t>u;f++){var s=r[0],c=Math.min(t-u,s.length);o?n+=s.slice(0,c):s.copy(n,u,0,c),c<s.length?r[0]=s.slice(c):r.shift(),u+=c}}return n}function endReadable(t){var e=t._readableState;if(e.length>0)throw new Error("endReadable called on non-empty stream");!e.endEmitted&&e.calledRead&&(e.ended=!0,setImmediate(function(){e.endEmitted||0!==e.length||(e.endEmitted=!0,t.readable=!1,t.emit("end"))}))}function forEach(t,e){for(var n=0,r=t.length;r>n;n++)e(t[n],n)}function indexOf(t,e){for(var n=0,r=t.length;r>n;n++)if(t[n]===e)return n;return-1}module.exports=Readable,Readable.ReadableState=ReadableState;var EE=require("../events").EventEmitter,Stream=require("./stream"),Buffer=require("../buffer").Buffer,setImmediate=require("@@nodeProcess").nextTick,StringDecoder,inherits=require("npm:inherits@^2.0.1");inherits(Readable,Stream),Readable.prototype.push=function(t,e){var n=this._readableState;return"string"!=typeof t||n.objectMode||(e=e||n.defaultEncoding,e!==n.encoding&&(t=new Buffer(t,e),e="")),readableAddChunk(this,n,t,e,!1)},Readable.prototype.unshift=function(t){var e=this._readableState;return readableAddChunk(this,e,t,"",!0)},Readable.prototype.setEncoding=function(t){StringDecoder||(StringDecoder=require("../string_decoder").StringDecoder),this._readableState.decoder=new StringDecoder(t),this._readableState.encoding=t};var MAX_HWM=8388608;Readable.prototype.read=function(t){var e=this._readableState;e.calledRead=!0;var n=t;if(("number"!=typeof t||t>0)&&(e.emittedReadable=!1),0===t&&e.needReadable&&(e.length>=e.highWaterMark||e.ended))return emitReadable(this),null;if(t=howMuchToRead(t,e),0===t&&e.ended)return 0===e.length&&endReadable(this),null;var r=e.needReadable;e.length-t<=e.highWaterMark&&(r=!0),(e.ended||e.reading)&&(r=!1),r&&(e.reading=!0,e.sync=!0,0===e.length&&(e.needReadable=!0),this._read(e.highWaterMark),e.sync=!1),r&&!e.reading&&(t=howMuchToRead(n,e));var i;return i=t>0?fromList(t,e):null,null===i&&(e.needReadable=!0,t=0),e.length-=t,0!==e.length||e.ended||(e.needReadable=!0),e.ended&&!e.endEmitted&&0===e.length&&endReadable(this),i},Readable.prototype._read=function(){this.emit("error",new Error("not implemented"))},Readable.prototype.pipe=function(t,e){function n(t){t===f&&i()}function r(){t.end()}function i(){t.removeListener("close",a),t.removeListener("finish",s),t.removeListener("drain",p),t.removeListener("error",o),t.removeListener("unpipe",n),f.removeListener("end",r),f.removeListener("end",i),(!t._writableState||t._writableState.needDrain)&&p()}function o(e){u(),0===d&&0===EE.listenerCount(t,"error")&&t.emit("error",e)}function a(){t.removeListener("finish",s),u()}function s(){t.removeListener("close",a),u()}function u(){f.unpipe(t)}var f=this,l=this._readableState;switch(l.pipesCount){case 0:l.pipes=t;break;case 1:l.pipes=[l.pipes,t];break;default:l.pipes.push(t)}l.pipesCount+=1;var c=(!e||e.end!==!1)&&t!==process.stdout&&t!==process.stderr,h=c?r:i;l.endEmitted?setImmediate(h):f.once("end",h),t.on("unpipe",n);var p=pipeOnDrain(f);t.on("drain",p);var d=EE.listenerCount(t,"error");return t.once("error",o),t.once("close",a),t.once("finish",s),t.emit("pipe",f),l.flowing||(this.on("readable",pipeOnReadable),l.flowing=!0,setImmediate(function(){flow(f)})),t},Readable.prototype.unpipe=function(t){var e=this._readableState;if(0===e.pipesCount)return this;if(1===e.pipesCount)return t&&t!==e.pipes?this:(t||(t=e.pipes),e.pipes=null,e.pipesCount=0,this.removeListener("readable",pipeOnReadable),e.flowing=!1,t&&t.emit("unpipe",this),this);if(!t){var n=e.pipes,r=e.pipesCount;e.pipes=null,e.pipesCount=0,this.removeListener("readable",pipeOnReadable),e.flowing=!1;for(var i=0;r>i;i++)n[i].emit("unpipe",this);return this}var i=indexOf(e.pipes,t);return-1===i?this:(e.pipes.splice(i,1),e.pipesCount-=1,1===e.pipesCount&&(e.pipes=e.pipes[0]),t.emit("unpipe",this),this)},Readable.prototype.on=function(t,e){var n=Stream.prototype.on.call(this,t,e);if("data"!==t||this._readableState.flowing||emitDataEvents(this),"readable"===t&&this.readable){var r=this._readableState;r.readableListening||(r.readableListening=!0,r.emittedReadable=!1,r.needReadable=!0,r.reading?r.length&&emitReadable(this,r):this.read(0))}return n},Readable.prototype.addListener=Readable.prototype.on,Readable.prototype.resume=function(){emitDataEvents(this),this.read(0),this.emit("resume")},Readable.prototype.pause=function(){emitDataEvents(this,!0),this.emit("pause")},Readable.prototype.wrap=function(t){var e=this._readableState,n=!1,r=this;t.on("end",function(){if(e.decoder&&!e.ended){var t=e.decoder.end();t&&t.length&&r.push(t)}r.push(null)}),t.on("data",function(i){if(e.decoder&&(i=e.decoder.write(i)),i&&(e.objectMode||i.length)){var o=r.push(i);o||(n=!0,t.pause())}});for(var i in t)"function"==typeof t[i]&&"undefined"==typeof this[i]&&(this[i]=function(e){return function(){return t[e].apply(t,arguments)}}(i));var o=["error","close","destroy","pause","resume"];return forEach(o,function(e){t.on(e,function(t){return r.emit.apply(r,e,t)})}),r._read=function(){n&&(n=!1,t.resume())},r},Readable._fromList=fromList;
//# sourceMappingURL=jspm_packages\github\jspm\nodelibs@0.0.2/stream\readable.src.js.map